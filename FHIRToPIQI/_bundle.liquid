{% assign entries = msg.entry | to_array -%}
{% assign resources = entries | map: "resource" %}
{% assign patient = resources | where: "resourceType", "Patient" | first %}
{% assign allergies = resources | where: "resourceType", "AllergyIntolerance" %}
{% assign carePlans = resources | where: "resourceType", "CarePlan" %}
{% assign claims = resources | where: "resourceType", "Claim" %}
{% assign conditions = resources | where: "resourceType", "Condition" %}
{% assign devices = resources | where: "resourceType", "Device" %}
{% assign reports = resources | where: "resourceType", "DiagnosticReport" %}
{% assign docs = resources | where: "resourceType", "DocumentReference" %}
{% assign encounters = resources | where: "resourceType", "Encounter" %}
{% assign goals = resources | where: "resourceType", "Goal" %}
{% assign immunizations = resources | where: "resourceType", "Immunization" %}
{% assign medRequests = resources | where: "resourceType", "MedicationRequest" %}
{% assign medications = resources | where: "resourceType", "Medication" %}
{% assign medStatements = resources | where: "resourceType", "MedicationStatement" %}
{% assign medAdmin = resources | where: "resourceType", "MedicationAdministration" %}
{% assign medDispense = resources | where: "resourceType", "MedicationDispense" %}
{% assign observations = resources | where: "resourceType", "Observation" %}
{% assign specimens = resources | where: "resourceType", "Specimen" %}
{% assign procedures = resources | where: "resourceType", "Procedure" %}


{% capture medReqRefsString %}
  {% for req in medRequests %}
    {% if req.medicationReference.reference %}
      {{ req.medicationReference.reference }},
    {% endif %}
  {% endfor %}
{% endcapture %}
{% assign medReqRefsString = medReqRefsString | strip | strip_newlines %}

{% capture medStatRefsString %}
  {% for req in medStatements %}
    {% if req.medicationReference.reference %}
      {{ req.medicationReference.reference }},
    {% endif %}
  {% endfor %}
{% endcapture %}
{% assign medStatRefsString = medStatRefsString | strip | strip_newlines %}

{% capture medAdminRefsString %}
  {% for req in medAdmin %}
    {% if req.medicationReference.reference %}
      {{ req.medicationReference.reference }},
    {% endif %}
  {% endfor %}
{% endcapture %}
{% assign medAdminRefsString = medAdminRefsString | strip | strip_newlines %}

{% capture medDispenseRefsString %}
  {% for req in medDispense %}
    {% if req.medicationReference.reference %}
      {{ req.medicationReference.reference }},
    {% endif %}
  {% endfor %}
{% endcapture %}
{% assign medDispenseRefsString = medDispenseRefsString | strip | strip_newlines %}

"messageID": "{{ patient.id }}",
"patient": {
  {% include '_patient' msg: patient -%}

  {% if allergies.size > 0 %}
	{% include '_allergyintolerance' allergies: allergies -%}
  {% endif %}

  {% if conditions.size >0 %}
	{% include '_condition' conditions: conditions -%}
  {% endif %}

  {% if immunizations.size > 0 %}
	{% include '_immunization' immunizations: immunizations -%}
  {% endif %}

  {% if reports.size > 0 %}
	{% include '_diagnosticreport' reports: reports -%}
  {% endif %}

  {% if medRequests.size > 0 or medStatements.size > 0 or medications.size >0 or medAdmin.size >0 or medDispense.size >0 %}
  "medications":[
	{% if medRequests.size > 0 %}
	{% for med in medRequests %}
	  {% include '_medication' med: med, type: "MedicationRequest", refs: medications -%}
	{% endfor %}
	{% endif %}
	{% if medStatements.size > 0 %}
	{% for med in medStatements %}
	  {% include '_medication' med: med, type: "MedicationStatement", refs: medications -%}
	{% endfor %}
	{% endif %}
	{% if medAdmin.size > 0 %}
	{% for med in medAdmin %}
	  {% include '_medication' med: med, type: "MedicationAdministration", refs: medications -%}
	{% endfor %}
	{% endif %}
	{% if medDispense.size > 0 %}
	{% for med in medDispense %}
	  {% include '_medication' med: med, type: "MedicationDispense", refs: medications -%}
	{% endfor %}
	{% endif %}
	{% if medications.size > 0 %}
	{% for med in medications %}
	
	{% assign fullURL = "urn:uuid:" | append: med.id | append: "," %}
	{% assign fullURL1 = "Medication/" | append: med.id | append: "," %}
	
	{% assign isReferenced = false %}
	
	{% if medReqRefsString contains fullUrl or medReqRefsString contains fullUrl1 %}
	  {% assign isReferenced = true %}
	{% endif %}

	{% if medStatRefsString contains fullUrl or medStatRefsString contains fullUrl1 %}
	  {% assign isReferenced = true %}
	{% endif %}

	{% if medAdminRefsString contains fullUrl or medAdminRefsString contains fullUrl1 %}
	  {% assign isReferenced = true %}
	{% endif %}

	{% if medDispenseRefsString contains fullUrl or medDispenseRefsString contains fullUrl1 %}
	  {% assign isReferenced = true %}
	{% endif %}

	{% unless isReferenced %}
	   {% include '_medication' med: med, type: "Medication" -%}
	{% endunless %}
	{% endfor %}
	{% endif %}
  ],
  {% endif %}

  {% if observations.size > 0 %}
	{% include '_observation' observations: observations, reports: reports, specimens: specimens -%}
  {% endif %}

 {% if procedures.size > 0 %}
	{% include '_procedure' procedures: procedures -%}
  {% endif %}

  {% if devices.size >0 %}
	{% include '_device' devices: devices -%}
  {% endif %}

  {% if docs.size > 0 %}
	{% include '_documentReference' docs: docs -%}
  {% endif %}

  {% if encounters.size > 0 %}
	{% include '_encounter' encounters: encounters, conditions: conditions -%}
  {% endif %}

  {% if goals.size > 0 %}
	{% include '_goal' goals: goals -%}
  {% endif %}
}