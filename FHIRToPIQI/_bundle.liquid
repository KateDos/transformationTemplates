{% assign entries = msg.entry | to_array -%}
{% assign resources = entries | map: "resource" %}
{% assign patient = resources | where: "resourceType", "Patient" | first %}
{% assign allergies = resources | where: "resourceType", "AllergyIntolerance" %}
{% assign carePlans = resources | where: "resourceType", "CarePlan" %}
{% assign claims = resources | where: "resourceType", "Claim" %}
{% assign conditions = resources | where: "resourceType", "Condition" %}
{% assign devices = resources | where: "resourceType", "Device" %}
{% assign reports = resources | where: "resourceType", "DiagnosticReport" %}
{% assign docs = resources | where: "resourceType", "DocumentReference" %}
{% assign encounters = resources | where: "resourceType", "Encounter" %}
{% assign goals = resources | where: "resourceType", "Goal" %}
{% assign immunizations = resources | where: "resourceType", "Immunization" %}
{% assign medRequests = resources | where: "resourceType", "MedicationRequest" %}
{% assign medications = resources | where: "resourceType", "Medication" %}
{% assign medStatements = resources | where: "resourceType", "MedicationStatement" %}
{% assign medAdmin = resources | where: "resourceType", "MedicationAdministration" %}
{% assign medDispense = resources | where: "resourceType", "MedicationDispense" %}
{% assign observations = resources | where: "resourceType", "Observation" %}
{% assign procedures = resources | where: "resourceType", "Procedure" %}

{% assign medReqRef1 = medRequests | map: "medicationReference" %}
{% assign medReqRefs = medReqRef1 | map: "reference" %}
{% assign medReqRefsString = medReqRefs | join: ", " | append: "," %}

{% assign medStatRefs1 = medStatements | map: "medicationReference" %}
{% assign medStatRefs = medStatRefs1 | map: "reference" %}
{% assign medStatRefsString = medStatRefs | join: ", " | append: "," %}

{% assign medAdminRefs1 = medAdmin | map: "medicationReference" %}
{% assign medAdminRefs = medAdminRefs1 | map: "reference" %}
{% assign medAdminRefsString = medAdminRefs | join: ", " | append: "," %}

{% assign medDispenseRefs1 = medDispense | map: "medicationReference" %}
{% assign medDispenseRefs = medDispenseRefs1 | map: "reference" %}
{% assign medDispenseRefsString = medDispenseRefs | join: ", " | append: "," %}

"MessageId": "{{ patient.id }}",
"Patient": {
  {% include '_patient' msg: patient -%}

  {% if allergies.size > 0 %}
	{% include '_allergyintolerance' allergies: allergies -%}
  {% endif %}

  {% if conditions.size >0 %}
	{% include '_condition' conditions: conditions -%}
  {% endif %}

  {% if immunizations.size > 0 %}
	{% include '_immunization' immunizations: immunizations -%}
  {% endif %}

  {% if reports.size > 0 %}
	{% include '_diagnosticReport' reports: reports -%}
  {% endif %}

  {% if medRequests.size > 0 or medStatements.size > 0 or medications.size >0 or medAdmin.size >0 or medDispense.size >0 %}
  "Medications":[
	{% if medRequests.size > 0 %}
	{% for med in medRequests %}
	  {% include '_medication' med: med, type: "MedicationRequest", refs: medications -%}
	{% endfor %}
	{% endif %}
	{% if medStatements.size > 0 %}
	{% for med in medStatements %}
	  {% include '_medication' med: med, type: "MedicationStatement", refs: medications -%}
	{% endfor %}
	{% endif %}
	{% if medAdmin.size > 0 %}
	{% for med in medAdmin %}
	  {% include '_medication' med: med, type: "MedicationAdministration", refs: medications -%}
	{% endfor %}
	{% endif %}
	{% if medDispense.size > 0 %}
	{% for med in medDispense %}
	  {% include '_medication' med: med, type: "MedicationDispense", refs: medications -%}
	{% endfor %}
	{% endif %}
	{% if medications.size > 0 %}
	{% for med in medications %}
	
	{% assign fullURL = "urn:uuid:" | append: med.id | append: "," %}
	{% assign fullURL1 = "Medication/" | append: med.id | append: "," %}
	
	{% assign isReferenced = false %}
	
	{% if medReqRefsString contains fullUrl or medReqRefsString contains fullUrl1 %}
	  {% assign isReferenced = true %}
	{% endif %}

	{% if medStatRefsString contains fullUrl or medStatRefsString contains fullUrl1 %}
	  {% assign isReferenced = true %}
	{% endif %}

	{% if medAdminRefsString contains fullUrl or medAdminRefsString contains fullUrl1 %}
	  {% assign isReferenced = true %}
	{% endif %}

	{% if medDispenseRefsString contains fullUrl or medDispenseRefsString contains fullUrl1 %}
	  {% assign isReferenced = true %}
	{% endif %}

	{% unless isReferenced %}
	   {% include '_medication' med: med, type: "Medication" -%}
	{% endunless %}
	{% endfor %}
	{% endif %}
  ],
  {% endif %}

  {% if observations.size > 0 %}
	{% include '_observation' observations: observations, reports: reports -%}
  {% endif %}

 {% if procedures.size > 0 %}
	{% include '_procedure' procedures: procedures -%}
  {% endif %}

  {% if devices.size >0 %}
	{% include '_device' devices: devices -%}
  {% endif %}

  {% if docs.size > 0 %}
	{% include '_documentReference' docs: docs -%}
  {% endif %}

  {% if encounters.size > 0 %}
	{% include '_encounter' encounters: encounters -%}
  {% endif %}

  {% if goals.size > 0 %}
	{% include '_goal' goals: goals -%}
  {% endif %}
}