{% assign freq = dosage.timing.repeat.frequency %}
{% assign per = dosage.timing.repeat.period %}
{% assign perUnit = dosage.timing.repeat.periodUnit %}
{% assign timingText = "" %}

{% assign timingText = '' %}

{% for inst in dosage.additionalInstruction %}
  {% if inst.text %}
    {% assign d = inst.text | strip | replace: '\r\n', ' ' | replace: '\r', ' ' | replace: '\n', ' ' %}
    {% assign timingText =  timingText | append: d %}
  {% else %}
    {% if inst.coding.size > 0 %}
      {% assign d = inst.coding[0].display %}
      {% assign timingText =  timingText | append: d %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if freq and per and perUnit %}
  {% assign timingText = timingText | append: "Take " | append: freq | append: " time" %}
  {% if freq != 1 %}
    {% assign timingText = timingText | append: "s" %}
  {% endif %}
  {% assign timingText = timingText | append: " every " | append: per | append: " " | append: perUnit %}
  {% if per != 1 %}
    {% assign timingText = timingText | append: "s" %}
  {% endif %}
{% elsif freq and perUnit %}
  {% assign timingText = timingText | append: "Take " | append: freq | append: " time" %}
  {% if freq != 1 %}
    {% assign timingText = timingText | append: "s" %}
  {% endif %}
  {% assign timingText = timingText | append: " per " | append: perUnit %}
{% elsif dosage.timing.code %}
  {% assign timingText = timingText | append: dosage.timing.code.text | default: dosage.timing.code.coding[0].display %}
{% endif %}

{% if dosage.asNeeded == true or dosage.asNeeded == 'true' or dosage.asNeededBoolean == true or dosage.asNeededBoolean == 'true' -%}
  {% assign timingText = timingText | append: " as needed" %}
{% elsif dosage.asNeededCodeableConcept %}
  {% assign reasonText = dosage.asNeededCodeableConcept.text | default: dosage.asNeededCodeableConcept.coding[0].display %}
  {% assign timingText = timingText | append: " as needed for " | append: reasonText %}
{% endif %}

{% assign inst = timingText | strip | replace: '\\r\\n', ' ' | replace: '\\r', ' ' | replace: '\\n', ' ' | replace: '\r\n', ' ' | replace: '\r', ' ' | replace: '\n', ' ' %}
"instructions": "{{ inst }}",