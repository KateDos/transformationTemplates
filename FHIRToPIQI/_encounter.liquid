"encounters":[
{% for encounter in encounters %}
{% assign encounterId = encounter.id %}
{% assign encounterRef1 = "Encounter/" | append: encounterId %}
{% assign encounterRef2 = "urn:uuid:" | append: encounterId %}
{
  "encounterDateTime": "{{ encounter.period.start }}",
  "encounterDisposition": "{% if encounter.hospitalization and encounter.hospitalization.dischargeDisposition and encounter.hospitalization.dischargeDisposition.text %}{{ encounter.hospitalization.dischargeDisposition.text }}{% endif %}",
  "encounterIdentifier": "{% if encounter.identifier and encounter.identifier.size > 0 %}{{ encounter.identifier.first.value }}{% endif %}",
  "encounterLocation": "{% if encounter.location and encounter.location.size > 0 %}{{ encounter.location.first.location.display }}{% endif %}",

  {% if encounter.type and encounter.type.size > 0 %}
    {% if encounter.type[0].text %}
      "encounterType": "{{ encounter.type[0].text | strip }}",
    {% elsif encounter.type[0].coding and encounter.type[0].coding.size > 0 and encounter.type[0].coding[0].display %}
      "encounterType": "{{ encounter.type[0].coding[0].display | strip }}",
    {% endif %}
  {% endif %}

  "status": "{{ encounter.status }}",

  {% if encounter.class and encounter.class.display %}
  "class": "{{ encounter.class.display }}",
  {% endif %}

  {% if encounter.period.start %}
    "startDate": "{{ encounter.period.start }}",
  {% endif %}

  {% if encounter.period.end %}
    "endDate": "{{ encounter.period.end }}",
  {% endif %}

  {% if encounter.diagnosis %}
  "encounterDiagnosis": {
    "codings": [
    {% assign diag = encounter.diagnosis[0] %}
    {% for coding in diag.use.coding %}
    {
       {% include '_codableconcept' coding: coding -%}
    },
    {% endfor %}
    ],
    "text": "{{ diag.use.text | default: diag.use.coding[0].display }}"
  },
  {% else %}
  {% assign condFound = false %}
 
  {% for cond in conditions %}
  {% if cond.encounter.reference == encounterRef1 or cond.encounter.reference == encounterRef2 %}
  {% if condFound == false and cond.category and cond.category[0].coding and cond.category[0].coding[0].code == "encounter-diagnosis" %}
        "encounterDiagnosis": {
          "codings": [
            {% for coding in cond.code.coding %}
            {
               {% include '_codableconcept' coding: coding -%}
            },
            {% endfor %}
          ],
          "text": "{{ cond.code.text | default: cond.code.coding[0].display }}"
        },
        {% assign condFound = true %}
  {% endif %}
  {% endif %}
  {% endfor %}
  {% endif %}

  {% if encounter.reasonCode %}
   "encounterReason": {
    "codings": [
      {% for rc in encounter.reasonCode %}
        {% for coding in rc.coding %}
        {
           {% include '_codableconcept' coding: coding -%}
        },
        {% endfor %}
      {% endfor %}
    ],
    "text": "{{ encounter.reasonCode[0].text | default: encounter.reasonCode[0].coding[0].display }}"
  },
  {% endif %}
},
{% endfor %}
],